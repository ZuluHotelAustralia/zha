name: Build

jobs:
  build:
    using: 'docker'
    image: 'docker://docker.pkg.github.com/zuluhotelaustralia/zha/server:latest'
    - name: Checkout
      uses: actions/checkout@master
    - name: Compile
      run: |
        ./scripts/ecompile -C setup/ecompile.cfg
        tar -czvf ecl-archive.tgz `find . | egrep ".*\.ecl"`
    - name: Create live update package
      if: github.ref == 'refs/heads/live-updates'
      uses: actions/upload-artifact@v1
      with:
        name: ecl-archive-${{ github.sha }}
        path: ecl-archive.tgz
    - name: Publish to Registry
      uses: elgohr/Publish-Docker-Github-Action@master
      with:
        name: zuluhotelaustralia/zha/server
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        registry: docker.pkg.github.com